<!doctype html>
<html class="no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title>车辆调度-重交沥青搅拌站智慧生产管控系统</title>
	<link rel="stylesheet" type="text/css" href="static/layui/css/layui.css"/>
	<link rel="stylesheet" type="text/css" href="static/css/common.css" />
</head>

<body>
	<div class="header clearfix">
		<h2>重交沥青搅拌站智慧生产管控系统</h2>
		<div class="nav">
			<a href="index.html">
				<img src="static/images/icon_home1.png" alt="" />
				<span>首页</span>
			</a>
			<a href="weigh.html">
				<img src="static/images/icon_chengzhong1.png" alt="" />
				<span>称重过磅</span>
			</a>
			<a href="jiankong.html">
				<img src="static/images/icon_jiankong1.png" alt="" />
				<span>生产监控</span>
			</a>
			<a href="carmanage.html" class="active">
				<img src="static/images/icon_car2.png" />
				<span>车辆调度</span>
			</a>
			
			<a href="kucun.html">
				<img src="static/images/icon_kucun1.png" alt="" />
				<span>库存盘点</span>
			</a>
			<a href="javascript:;">
				<img src="static/images/icon_zhiliang1.png" alt="" />
				<span>质量管控</span>
			</a>
			<a href="javascript:;">
				<img src="static/images/icon_shiyan1.png" />
				<span>实验管理</span>
			</a>
			
			<a  id="tongji">
				<img src="static/images/icon_tongji1.png" />
				<span>统计分析</span>
			</a>
			<ul class="subnav">
				<li><a href="producestate.html">生产动态表</a></li>
				<li><a href="producenum.html">生产量分析</a></li>
				<li><a href="hsl.html">核算量分析</a></li>
				<li><a href="xhl.html">消耗量分析</a></li>
				<li><a href="temp.html">温度波动分析</a></li>
				<li><a href="ysb.html">油石比波动分析</a></li>
			</ul>
		</div>
	</div>


	
	<div class="container">
		<div class="car-list fl">
			<ul id="carList">
				<li class="active">车辆列表</li>
				<li>渝B123</li>
				<li>渝B223</li>
				<li class="active">渝B323</li>
				<li>渝B423</li>
			</ul>
		</div>
		<div class="car-map fr" id="map">
			
		</div>
	</div>
		
		
<script src="static/js/jquery-1.11.0.min.js" type="text/javascript" charset="utf-8"></script>
<script src="static/js/common.js"></script>
<script src="static/js/echarts.min.js" type="text/javascript" charset="utf-8"></script>
<script src="static/laydate/laydate.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=wqB7npvF7DsDGlFG2oYhih93K5iEqsou"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/LuShu/1.2/src/LuShu_min.js"></script>
<script src="static/js/api.js" type="text/javascript" charset="utf-8"></script>
<script src="static/js/map.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
	// 车辆列表
	ajaxData(carList,{},function(data){
		console.log(data)
		var carStr = '';
		for(var i=0;i<data.list.length;i++){
			carStr += '<li carnum="'+data.list[i].carNo+'">'+data.list[i].carNo+'</li>';
		}
		
		
		lushuFn()
		$('#carList').html(carStr);
		$('#carList li').bind('click',function(){
			var carNo = $(this).attr('carnum');
			console.log(carNo);
			
			
			// 车辆轨迹
			carTrailFn(carNo);
		})
		
		
		if(data.list.length > 0){
			map.clearOverlays();
	   		for (var i = 0; i < data.list.length ; i ++) {
				// 地图标注
				var lng = data.list[i].location.lng;
				var lat = data.list[i].location.lat;
				var point = new BMap.Point(lng,lat);
				console.log(lng)
				map.centerAndZoom(point, 15); 
				
				var opt = {
					width : 300,     // 信息窗口宽度
					height: 100,     // 信息窗口高度
					//title : data[i].vno , // 信息窗口标题
					
				}
				var content ='<p style="font-weight:bold">车辆号码：'+ data.list[i].carNo +'</p>'
						+'<p>mileage:'+ data.list[i].location.mileage +'</p>'
						+'<p>出货时间：'+ data.list[i].location.stime+'</p>'
						+'<p>车辆位置：'+ data.list[i].location.location +'</p>'
						
				var InfoWindow = new BMap.InfoWindow(content,opt);
				InfoWindow.enableAutoPan();
				var label = data.list[i].carNo;
				var icon = new BMap.Icon("http://developer.baidu.com/map/jsdemo/img/car.png", new BMap.Size(52,26));
				addMarker(point,icon,label,InfoWindow);
	   		}
		}
	})
	
	// 车辆轨迹
	function carTrailFn(carNo){
		ajaxData(carTrail,{carNo:carNo},function(data){
			console.log(data);
			//lushuFn(data,marker)
			if(data.errno == 0){
				map.clearOverlays();     
		       	marker.hide();
		        lushu.start();
			}
			
		})
	}
	

	
	var lushu;//实例化一个驾车导航用来生成路线
	
	function lushuFn(){
		
		var startPoint = new BMap.Point(106.22482429338852,29.57938583045226);
		var endPoint = new BMap.Point(106.33733490755822,29.620764628790734);
	  	var drv = new BMap.DrivingRoute(startPoint, {
	    	onSearchComplete: function(res) {
	    		
		    if (drv.getStatus() == BMAP_STATUS_SUCCESS) {
			  	var plan = res.getPlan(0);
			 	var arrPois =[];
			    for(var j=0;j<plan.getNumRoutes();j++){
				   	var route = plan.getRoute(j);
				   	arrPois= arrPois.concat(route.getPath());
				}
			    //console.log(arrPois)
		
				map.setViewport(arrPois); 
				marker=new BMap.Marker(arrPois[0],{
				    icon  : new BMap.Icon('http://developer.baidu.com/map/jsdemo/img/car.png', new BMap.Size(52,26),{anchor : new BMap.Size(27, 13)})
				});
				var label = new BMap.Label("渝C61358",{offset:new BMap.Size(0,-30)});
				label.setStyle({border:"1px solid rgb(204, 204, 204)",color: "rgb(0, 0, 0)",borderRadius:"10px",padding:"5px",background:"rgb(255, 255, 255)",});
				marker.setLabel(label);
		
				BMapLib.LuShu.prototype._move=function(initPos,targetPos,effect) {
				    var pointsArr=[initPos,targetPos];  //点数组
				    var me = this,
				    //当前的帧数
				    currentCount = 0,
				    //步长，米/秒
		            timer =50,
		            step = this._opts.speed / (1000 / timer),
				    //初始坐标
		            init_pos = this._projection.lngLatToPoint(initPos),
				    //获取结束点的(x,y)坐标
		            target_pos = this._projection.lngLatToPoint(targetPos),
				    //总的步长
				            count = Math.round(me._getDistance(init_pos, target_pos) / step);
				    //显示折线 syj201607191107
				    this._map.addOverlay(new BMap.Polyline(pointsArr, {
				        strokeColor : "blue",
				        strokeWeight : 5,
				        strokeOpacity : 0.5
				    })); // 画线
				    //如果小于1直接移动到下一点
				    if (count < 1) {
				        me._moveNext(++me.i);
				        return;
				    }
				
				    me._intervalFlag = setInterval(function() {
				        //两点之间当前帧数大于总帧数的时候，则说明已经完成移动
				        if (currentCount >= count) {
				            clearInterval(me._intervalFlag);
				
				            //移动的点已经超过总的长度
				            if(me.i > me._path.length){
				                return;
				            }
				            //运行下一个点
				            me._moveNext(++me.i);
				        }else {
				            currentCount++;
				            var x = effect(init_pos.x, target_pos.x, currentCount, count),
				                    y = effect(init_pos.y, target_pos.y, currentCount, count),
				                    pos = me._projection.pointToLngLat(new BMap.Pixel(x, y));
				            //设置marker
				            if(currentCount == 1){
				                var proPos = null;
				                if(me.i - 1 >= 0){
				                    proPos = me._path[me.i - 1];
				                }
				                if(me._opts.enableRotation == true){
				                    me.setRotation(proPos,initPos,targetPos);
				                }
				                if(me._opts.autoView){
				                    if(!me._map.getBounds().containsPoint(pos)){
				                        me._map.setCenter(pos);
				                    }
				                }
				            }
				            //正在移动
				            me._marker.setPosition(pos);
				            //设置自定义overlay的位置
				            me._setInfoWin(pos);
				        }
				    },timer);
				};
			    lushu = new BMapLib.LuShu(map,arrPois,{
			        defaultContent:"渝C61358",//"从天安门到百度大厦"
			        autoView:true,//是否开启自动视野调整，如果开启那么路书在运动过程中会根据视野自动调整
			        icon  : new BMap.Icon('http://developer.baidu.com/map/jsdemo/img/car.png', new BMap.Size(52,26),{anchor : new BMap.Size(27, 13)}),
			        speed: 4500,
			        enableRotation:true,//是否设置marker随着道路的走向进行旋转
			        landmarkPois:[
			            {lng:116.306954,lat:40.05718,html:'加油站',pauseTime:2}
			        ]
			
			    });
		
			    marker.addEventListener("click",function(){
			        marker.enableMassClear();   //设置后可以隐藏改点的覆盖物
			        marker.hide();
			        lushu.start();
			        //map.clearOverlays();  //清除所有覆盖物
				});
			    }
	        }
	    });
	    
	    
	   	// drv.search('天安门', '百度大厦');
		drv.search(startPoint, endPoint);
		
	}
		
		
	
		
	</script>
	</body>

</html>