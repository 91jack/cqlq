<!doctype html>
<html class="no-js">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>重交沥青搅拌站智慧生产管控系统</title>
		<link rel="stylesheet" type="text/css" href="static/layui/css/layui.css"/>
		<link rel="stylesheet" type="text/css" href="static/css/common.css" />
		<link rel="stylesheet" type="text/css" href="static/css/index.css"/>
	</head>

	<body>
		<div class="header clearfix">
			<h2>重交沥青搅拌站智慧生产管控系统</h2>
			<div class="nav">
				<a href="index.html">
					<img src="static/images/icon_home1.png" alt="" />
					<span>首页</span>
				</a>
				<a href="weigh.html">
					<img src="static/images/icon_chengzhong1.png" alt="" />
					<span>称重过磅</span>
				</a>
				<a href="jiankong.html">
					<img src="static/images/icon_jiankong1.png" alt="" />
					<span>生产监控</span>
				</a>
				<a href="carmanage.html">
					<img src="static/images/icon_car1.png" />
					<span>车辆调度</span>
				</a>
				<a href="javascript:;" id="tongji">
					<img src="static/images/icon_tongji1.png" />
					<span>统计分析</span>
				</a>
				<ul class="subnav">
						<li><a href="producestate.html">生产动态表</a></li>
						<li><a href="producenum.html">生产量分析</a></li>
						<li><a href="">核算量分析</a></li>
						<li><a href="">消耗量分析</a></li>
						<li><a href="">温度波动分析</a></li>
					</ul>
			</div>
		</div>

		<div class="top-title clearfix">
			<img src="static/images/top_title.png" alt="" />
			<h1>重交沥青搅拌站智慧生产管控系统</h1>
		</div>

		<div class="main">
			<div class="section1 fl">
				<div class="section1-top">
					<div class="section1-top-item section1-top-item1">
						<div class="intro"></div>
						<div class="intro-text">生产量</div>
						<div class="produce-num"><span id="productTotal">150000</span>吨</div>
					</div>
					<div class="section1-top-item section1-top-item2">
						<div class="intro"></div>
						<div class="intro-text">发货量</div>
						<div class="produce-num"><span>130000</span>吨</div>
					</div>
				</div>
				<div class="section1-bottom">
					<h2>拌站场区视频监控画面   <a href="http://192.168.2.222" target="_blank" class="fr">查看全部监控</a></h2>
					<div class="video-list">
						<div id="login_install_dialog" style="display:none;height:20px; width:400px;padding-top:30px; margin:auto;">
							<div style="clear: both;zoom:1; border: 2px solid #373737;background: #D5D5D5;">
								<a id="login_btn_install" href="plguin/webplugin.exe" target="_download" onclick="instal()" style="background: rgb(255,0,0);">Instal</a>
								<a id="login_btn_cancel" href="javascript:;">Cancle</a>
							</div>
						</div>
						<div id="f_ocx" style="top:60px; left:0; width: 436px; height: 436px;"></div>
					</div>
				</div>
			</div>

			<div class="section2 fl">
				<div class="section2-top">
					<h2>运输车辆地图</h2>
					<div id="map"></div>
				</div>
				<div class="section2-bottom">
					<div class="section2-bottom-item fl">
						<h2>生产消耗</h2>
						<div class="chuhuo-list" >
							<table  cellpadding="20" cellspacing="0">
								<thead>
									<tr>
										<th>时间</th>
										<th>集料</th>
										<th>添加剂</th>
										<th>矿粉</th>
										<th>沥青</th>
									</tr>
								</thead>
								<tbody id="productList">
									
								</tbody>
							</table>
							
							
						
						</div>
					</div>
					<div class="section2-bottom-item fr">
						<h2>出货详情</h2>
						<div class="chuhuo-list" >
							<table  cellpadding="20" cellspacing="0">
								<thead>
									<tr>
										<th>项目名称</th>
										<th>车牌号</th>
										<th>净重</th>
										<th>出货时间</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>10:33:23</td>
										<td>111</td>
										<td>888</td>
										<td>333</td>
									</tr>
									<tr>
										<td>10:33:23</td>
										<td>111</td>
										<td>888</td>
										<td>333</td>
									</tr>
									<tr>
										<td>10:33:23</td>
										<td>111</td>
										<td>888</td>
										<td>333</td>
									</tr>
									<tr>
										<td>10:33:23</td>
										<td>111</td>
										<td>888</td>
										<td>333</td>
									</tr>
									<tr>
										<td>10:33:23</td>
										<td>111</td>
										<td>888</td>
										<td>333</td>
									</tr>
								</tbody>
							</table>

						</div>
					</div>
				</div>
			</div>

			<div class="section3 fl">
				<div class="section3-top1">
					<h1>当前生产材料:<span id="productName"></span></h1>
				</div>
				<div class="section3-top">
					<h2>生产数据</h2>
					<div class="section3-top-content">
						<div class="section3-top-item">
							<div class="guliao">150°C</div>
							<p>骨料温度</p>
						</div>
						<div class="section3-top-item">
							<div class="chucai">100°C</div>
							<p>出材温度</p>
						</div>
						<div class="section3-top-item">
							<div class="ratio" id="ratio"></div>
							<p>油石比</p>
						</div>
					</div>
				</div>
				<div class="section3-bottom">
					<div class="section3-chart1">
						<h2>油石比</h2>
						<div class="time-wrap">
							<div class="start-time">
								<span>开始时间</span>
								<input type="text" id="startTime">
							</div>
							<div class="end-time">
								<span>结束时间</span>
								<input type="text" id="endTime">
							</div>
							<a href="javascript:;" class="btn">确定</a>
						</div>
						
						
						<div id="lineChart"></div>
					</div>

					<div class="section3-chart2">
						<h2>温度</h2>
						<div id="barChart"></div>
					</div>
				</div>
			</div>
		</div>

<script src="static/js/jquery-1.11.0.min.js" type="text/javascript" charset="utf-8"></script>
<script src="static/js/common.js"></script>
<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=wqB7npvF7DsDGlFG2oYhih93K5iEqsou"></script>
<script src="static/js/echarts.min.js" type="text/javascript" charset="utf-8"></script>
<script src="static/js/index.js" type="text/javascript" charset="utf-8"></script>
<!--<script src="static/laydate/laydate.js" type="text/javascript" charset="utf-8"></script>-->
<script src="static/layui/layui.all.js" type="text/javascript" charset="utf-8"></script>
<script src="static/js/jquery.tempgauge.js" type="text/javascript" charset="utf-8"></script>
<script src="static/js/video.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
	//LoginDevice()
	
	
	// 时间选择
	layui.use('laydate', function(){
	  var laydate = layui.laydate;
	  
	 
	  laydate.render({
	    elem: '#startTime',
	    value:'2018-09-01'
	  });
	  
	  laydate.render({
	   elem: '#endTime',
	   value:'2018-09-26'
	  });
	});
	
	

	$(".guliao").tempGauge({width:50, borderWidth:2, showLabel:true, borderColor:"#19B6E8",maxTemp:200,fillColor:'#FAB80C'});     
	$(".chucai").tempGauge({width:50, borderWidth:2, showLabel:true, borderColor:"#19B6E8",maxTemp:200,fillColor:'#FF7979'});

	
	// 地图初始化
	var map = new BMap.Map("map"); // 创建Map实例
	var point = new BMap.Point(106.662101,29.501584);//赵家乡政府
	map.centerAndZoom(point, 14); // 初始化地图,设置中心点坐标和地图级别
	map.enableScrollWheelZoom(true); // 缩放地图
			

	// 添加带有定位的导航控件
	var navigationControl = new BMap.NavigationControl({
		// 靠左上角位置
		anchor: BMAP_ANCHOR_TOP_LEFT,
		// LARGE类型
		type: BMAP_NAVIGATION_CONTROL_LARGE,
		// 启用显示定位
	    enableGeolocation: true
	});
	
	map.addControl(navigationControl);
	
	// 添加定位控件
	var geolocationControl = new BMap.GeolocationControl();
	geolocationControl.addEventListener("locationSuccess", function(r){
	 	map.clearOverlays();
	 	mapinit(r);
		curPoint = r.point;
	});
	
	geolocationControl.addEventListener("locationError",function(e){
	// 定位失败事件
	    alert(e.message);
	});
	map.addControl(geolocationControl);
	

	function mapinit(r){
		var positionIcon = new BMap.Icon("static/mapicon/icon_position.png", new BMap.Size(18,33));
		var positionMarker = new BMap.Marker(r.point,{icon:positionIcon});
		
		positionMarker.addEventListener('click',attribute);
		map.addOverlay(positionMarker); 
		positionMarker.enableDragging();//可拖拽
			
		map.panTo(r.point);
		
		function attribute(){
			var p = positionMarker.getPosition(); // 获取marker的位置
			console.log(p);
			console.log(p.lng,p.lat);
			
			map.centerAndZoom(new BMap.Point(p.lng,p.lat), 14); // 初始化地图,设置中心点坐标和地图级别
			
			var geoc = new BMap.Geocoder();
			geoc.getLocation(p,function(rs){
				console.log(rs)
				var addComp = rs.addressComponents;
				var newaddress = '';
				newaddress += addComp.street;
				newaddress += addComp.streetNumber;
				
				console.log(newaddress);
			});
		}
	}
	
	// 油石比
	var GetYSBUrl = 'http://192.168.1.123:8080/jbz/api/data/ajaxGetYSB';
	
	// 首页图表（折线图、柱状图）
	
	
	$('.btn').click(function(){
		indexChart();
	})
	
	
	function indexChart(){
		var params = {
			beginDate:$('#startTime').val(),
			endDate:$('#endTime').val(),
			productName:$('#productName').text()
		}
		
		ajaxData(GetYSBUrl,params,function(data){
			//console.log(data)
			var xData = data.list.map(function(index,value){
				return index.dateTime;
			})
			var yData = data.list.map(function(index,value){
				return index.rate;
			})
			// 折线图
			var lineChart = echarts.init(document.getElementById('lineChart'));
			var option = {
				grid: {
					//				show:true,
					top: 35,
					left: 40,
					right:0,
					bottom:10
					
				},
				tooltip: {
			        trigger: 'axis',  
			    },
				xAxis: {
					type: 'category',
					data:xData,
					axisLine: {
						lineStyle: {
							color: '#148976'
						}
					},
					axisTick: {
						lineStyle: {
							color: '#fff'
						}
					},
	
				},
				yAxis: {
					name:'油石比（%）',
					type: 'value',
					splitLine: {
						show: false
					},
					axisLine: {
						show: true,
						lineStyle: {
							color: '#148976'
						}
					},
					axisTick: {
						lineStyle: {
							color: '#fff'
						}
					},
				},
				series: [{
					name:'油石比',
					type: 'line',
					data: yData,
					itemStyle: {
						color: '#FFAE00'
					}
				}]
			};
	
			lineChart.setOption(option);
		})
		
	}
 	// 调用数据
 	// GPS
 	var gpsUrl = "ws://192.168.1.123:8080/jbz/gps";
	WebSocketFn(gpsUrl,function(data){
		
		var data = JSON.parse(data) 
   		
   		if(data.length > 0){
   			map.clearOverlays();
	   		for (var i = 0; i < data.length ; i ++) {
				// 地图标注
				var lng = data[i].lng;
				var lat = data[i].lat;
				var point = new BMap.Point(lng,lat);
				
				map.centerAndZoom(point, 15); 
				
				var label = data[i].vno;
				var icon = new BMap.Icon("static/images/icon_car.png", new BMap.Size(33,21));
				addMarker(point,icon,label);
	   		}
  		}
	});
	
	// 生产数据
	var productUrl = "ws://192.168.1.123:8080/jbz/product";
	WebSocketFn(productUrl,function(data){
		var data = JSON.parse(data) 
   		$('#productTotal').html(data.productTotal);
   		$('#productName').html(data.productName);
   		
   		// 生产消耗
   		var str = ''
   		if(!data.rate){
   			return;
   		}
   		
   		if(data.productList.length>0){
   			
	   		for(var i=0;i<data.productList.length;i++){
	   			str +='<tr>'
					+	'<td>'+data.productList[i].dateTime+'</td>'
					+	'<td>'+data.productList[i].glsl+'</td>'
					+	'<td>'+data.productList[i].tjjsl+'</td>'
					+	'<td>'+data.productList[i].xfsl+'</td>'
					+	'<td>'+data.productList[i].lqsl+'</td>'
					+'</tr>'
	   		}
	   		
	   		if(data.productList.length == 5){
   				$('#productList').html(str);
   			}else{
   				$('#productList').prepend(str);
   				var n = $('#productList  tr').length-1;
   				$('#productList tr').eq(n).remove();
   			}
   		}
   		
   		
   		
   		$('#ratio').html(data.rate+'%');
		$(".ratio").tempGauge({width:50, borderWidth:0, showLabel:true, borderColor:"#19B6E8",maxTemp:100,fillColor:'#00CAB0'});
   		
   		indexChart();
	});
		
		
	
	
	
		
	// websocket函数
	function WebSocketFn(url,callback){
        if ("WebSocket" in window){
          // console.log("您的浏览器支持 WebSocket!");
           // 打开一个 web socket
           var ws = new WebSocket(url);
            
           ws.onopen = function(){
              // Web Socket 已连接上，使用 send() 方法发送数据
              //ws.send("发送数据");
              //alert("数据发送中...");
           };
            
           ws.onmessage = function (evt) { 
              var received_msg = evt.data;
              //console.log(received_msg);
              callback(received_msg);
              //alert("数据已接收...");
           };
            
           ws.onclose = function(){ 
              // 关闭 websocket
              console.log("连接已关闭..."); 
           };
        }else{
           // 浏览器不支持 WebSocket
           alert("您的浏览器不支持 WebSocket!");
        }
    }
	
	// ajax数据请求
	function ajaxData(url,params,callback){
		$.ajax({
			type:"get",
			url:url,
			data:params,
			success:function(res){
				//console.log(res);
				callback(res)
			}
		});
	}
		
	// 添加标注函数
	function addMarker(point,icon,label){
	  	var marker = new BMap.Marker(point,{icon:icon});
	  
	  	map.addOverlay(marker);
		var opts = {
		  position : point,    // 指定文本标注所在的地理位置
		  offset   : new BMap.Size(15,-20)    //设置文本偏移量
		}
		
		var label = new BMap.Label(label, opts);  // 创建文本标注对象
		label.setStyle({
			 color : "red",
			 fontSize : "12px",
			 height : "20px",
			 lineHeight : "20px",
			 fontFamily:"微软雅黑"
		});
	  
	 	marker.setLabel(label)
	}
	

</script>
</body>
</html>